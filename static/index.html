<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraAI - Multi-LLM Orchestrator</title>
    <link rel="stylesheet" href="/css/themes.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-purple));
            color: white;
            border-radius: 12px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .config-status {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid var(--accent-blue);
        }

        .config-status.demo-mode {
            border-left-color: var(--warning-color);
            background: #fff3cd;
        }

        .config-status.production-mode {
            border-left-color: var(--success-color);
            background: #d4edda;
        }

        .config-status h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .config-instructions {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .orchestrator-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .model-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .model-card {
            border: 2px solid var(--border-light);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .model-card:hover {
            border-color: var(--primary-blue);
            background: var(--bg-primary);
        }

        .model-card.selected {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: white;
        }

        .model-card input[type="checkbox"] {
            margin-right: 10px;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .execute-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .execute-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .execute-btn:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-blue);
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
        }

        .model-name {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .result-content {
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border-light);
            border-left: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: var(--error);
            background: #fee;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--error);
        }

        .model-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .analysis-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .preset-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
        }

        .preset-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .preset-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .api-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .api-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .feather-stage {
            border-left-width: 6px;
            position: relative;
        }

        .feather-stage:nth-child(1) { border-left-color: #10b981; }
        .feather-stage:nth-child(2) { border-left-color: #3b82f6; }
        .feather-stage:nth-child(3) { border-left-color: #8b5cf6; }
        .feather-stage:nth-child(4) { border-left-color: #f59e0b; }

        .stage-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .model-selection {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UltraAI Feather Orchestrator</h1>
            <p>Advanced analysis patterns across multiple LLM providers • Intelligence multiplication through structured collaboration</p>
        </div>

        <!-- Configuration Status -->
        <div id="configStatus" class="config-status">
            <h3>System Configuration</h3>
            <div id="configStatusContent">Loading configuration status...</div>
            <div id="configInstructions" class="config-instructions" style="display: none;"></div>
        </div>

        <div class="orchestrator-panel">
            <div id="apiStatus" class="api-status error" style="display: none;">
                ⚠️ API Keys not configured. The system will return demo responses showing API key errors. This is normal for the demo environment.
            </div>
            
            <h2>Multi-LLM Execution</h2>
            
            <div class="form-group">
                <label>Select LLM Models:</label>
                <div class="model-selection" id="modelSelection">
                    <div class="model-card" data-model="gpt-4">
                        <input type="checkbox" value="gpt-4" id="gpt-4">
                        <label for="gpt-4">GPT-4</label>
                        <div style="font-size: 0.8rem; color: #666;">OpenAI's most capable model</div>
                    </div>
                    <div class="model-card" data-model="gpt-3.5-turbo">
                        <input type="checkbox" value="gpt-3.5-turbo" id="gpt-3.5-turbo">
                        <label for="gpt-3.5-turbo">GPT-3.5 Turbo</label>
                        <div style="font-size: 0.8rem; color: #666;">Fast and cost-effective</div>
                    </div>
                    <div class="model-card" data-model="claude-3-opus">
                        <input type="checkbox" value="claude-3-opus" id="claude-3-opus">
                        <label for="claude-3-opus">Claude 3 Opus</label>
                        <div style="font-size: 0.8rem; color: #666;">Anthropic's most powerful model</div>
                    </div>
                    <div class="model-card" data-model="claude-3-sonnet">
                        <input type="checkbox" value="claude-3-sonnet" id="claude-3-sonnet">
                        <label for="claude-3-sonnet">Claude 3 Sonnet</label>
                        <div style="font-size: 0.8rem; color: #666;">Balanced performance</div>
                    </div>
                    <div class="model-card" data-model="claude-3-haiku">
                        <input type="checkbox" value="claude-3-haiku" id="claude-3-haiku">
                        <label for="claude-3-haiku">Claude 3 Haiku</label>
                        <div style="font-size: 0.8rem; color: #666;">Fastest Claude model</div>
                    </div>
                </div>
                <div class="model-count" id="modelCount">0 models selected</div>
            </div>

            <div class="form-group">
                <label>UltraAI Feather Analysis Patterns:</label>
                <div class="analysis-presets" id="analysisPresets">
                    <button type="button" class="preset-btn" data-prompt="Perform a Gut Analysis on: " title="Quick intuitive assessment of core issues">🧠 Gut Analysis</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Confidence Analysis on: " title="Quantify certainty in conclusions">📊 Confidence Analysis</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Critique Analysis on: " title="Identify flaws and weaknesses">🔍 Critique Analysis</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Fact Check Analysis on: " title="Verify factual accuracy">✅ Fact Check</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Perspective Analysis on: " title="Surface diverse viewpoints">👥 Perspective Analysis</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Scenario Analysis on: " title="Explore potential futures">🔮 Scenario Analysis</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Stakeholder Vision analysis on: " title="Map impact across stakeholders">🎯 Stakeholder Vision</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Systems Mapper analysis on: " title="Model complex system interactions">🗺️ Systems Mapper</button>
                    <button type="button" class="preset-btn" data-prompt="Perform a Time Horizon analysis on: " title="Analyze short/medium/long-term implications">⏰ Time Horizon</button>
                    <button type="button" class="preset-btn" data-prompt="Perform an Innovation Bridge analysis on: " title="Connect disparate fields for novel insights">💡 Innovation Bridge</button>
                </div>
            </div>

            <div class="form-group">
                <label for="promptInput">Enter your prompt:</label>
                <textarea id="promptInput" class="prompt-textarea" 
                    placeholder="Enter your question or topic here. You can use the analysis type buttons above or write a custom prompt..."></textarea>
            </div>

            <button id="executeBtn" class="execute-btn">
                Execute Across Selected Models
            </button>
        </div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <h2>Results</h2>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        class OrchestratorApp {
            constructor() {
                this.selectedModels = new Set();
                this.selectedPattern = 'gut'; // Default to Gut Analysis
                this.initializeEventListeners();
                this.loadConfigurationStatus();
            }

            initializeEventListeners() {
                // Model selection
                document.querySelectorAll('.model-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = card.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                        }
                        this.updateSelectedModels();
                    });
                });

                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.updateSelectedModels());
                });

                // Analysis preset buttons
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active class from all buttons
                        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        btn.classList.add('active');
                        
                        // Extract pattern name and set it
                        const buttonText = btn.textContent;
                        if (buttonText.includes('Gut')) this.selectedPattern = 'gut';
                        else if (buttonText.includes('Confidence')) this.selectedPattern = 'confidence';
                        else if (buttonText.includes('Critique')) this.selectedPattern = 'critique';
                        else if (buttonText.includes('Fact Check')) this.selectedPattern = 'fact_check';
                        else if (buttonText.includes('Perspective')) this.selectedPattern = 'perspective';
                        else if (buttonText.includes('Scenario')) this.selectedPattern = 'scenario';
                        else if (buttonText.includes('Stakeholder')) this.selectedPattern = 'stakeholder';
                        else if (buttonText.includes('Systems')) this.selectedPattern = 'systems';
                        else if (buttonText.includes('Time Horizon')) this.selectedPattern = 'time_horizon';
                        else if (buttonText.includes('Innovation')) this.selectedPattern = 'innovation';
                        
                        // Update prompt with template
                        const promptTemplate = btn.dataset.prompt;
                        const promptInput = document.getElementById('promptInput');
                        const currentValue = promptInput.value.trim();
                        
                        if (currentValue && !currentValue.startsWith(promptTemplate)) {
                            promptInput.value = promptTemplate + currentValue;
                        } else if (!currentValue) {
                            promptInput.value = promptTemplate;
                            promptInput.focus();
                            // Move cursor to end
                            promptInput.setSelectionRange(promptInput.value.length, promptInput.value.length);
                        }
                    });
                });

                // Execute button
                document.getElementById('executeBtn').addEventListener('click', () => this.executeOrchestrator());
                
                // Enter key in textarea
                document.getElementById('promptInput').addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.executeOrchestrator();
                    }
                });
            }

            updateSelectedModels() {
                this.selectedModels.clear();
                
                document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    this.selectedModels.add(checkbox.value);
                    checkbox.closest('.model-card').classList.add('selected');
                });

                document.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(checkbox => {
                    checkbox.closest('.model-card').classList.remove('selected');
                });

                const count = this.selectedModels.size;
                document.getElementById('modelCount').textContent = 
                    count === 0 ? '0 models selected' :
                    count === 1 ? '1 model selected' :
                    `${count} models selected`;

                document.getElementById('executeBtn').disabled = count === 0;
            }

            async executeOrchestrator() {
                const prompt = document.getElementById('promptInput').value.trim();
                if (!prompt) {
                    alert('Please enter a prompt');
                    return;
                }

                if (this.selectedModels.size === 0) {
                    alert('Please select at least one model');
                    return;
                }

                const executeBtn = document.getElementById('executeBtn');
                const resultsSection = document.getElementById('resultsSection');
                const resultsContainer = document.getElementById('resultsContainer');

                executeBtn.disabled = true;
                executeBtn.textContent = 'Executing...';
                
                resultsSection.style.display = 'block';
                resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Executing across selected models...</p></div>';

                try {
                    // Execute UltraAI Feather analysis with all selected models
                    const response = await fetch('/api/orchestrator/execute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            models: Array.from(this.selectedModels),
                            args: {},
                            kwargs: {}
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        this.displayFeatherResults(data);
                    } else {
                        throw new Error(data.detail || 'Unknown error occurred');
                    }

                } catch (error) {
                    resultsContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                    if (error.message.includes('API key') || error.message.includes('401')) {
                        document.getElementById('apiStatus').style.display = 'block';
                    }
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.textContent = 'Execute Across Selected Models';
                }
            }

            displayFeatherResults(data) {
                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.innerHTML = '';

                // Handle new multi-model response format
                if (data.result && data.result.responses) {
                    // Multi-model responses
                    data.result.responses.forEach((response, index) => {
                        const resultCard = document.createElement('div');
                        resultCard.className = 'result-card';
                        
                        // Check for API key errors
                        let isApiError = response.response && (response.response.includes('API key') || response.response.includes('Error:'));
                        
                        if (isApiError) {
                            resultCard.innerHTML = `
                                <div class="result-header">
                                    <div class="model-name">⚠️ ${response.model}</div>
                                </div>
                                <div class="api-status error">${response.response}</div>
                            `;
                        } else {
                            resultCard.innerHTML = `
                                <div class="result-header">
                                    <div class="model-name">🤖 ${response.model}</div>
                                </div>
                                <div class="result-content">${response.response}</div>
                            `;
                        }
                        
                        resultsContainer.appendChild(resultCard);
                    });
                }
                // Display Feather analysis stages (for future UltraAI patterns)
                else if (data.stages) {
                    data.stages.forEach((stage, index) => {
                        const stageCard = document.createElement('div');
                        stageCard.className = 'result-card feather-stage';
                        
                        const stageNames = ['Initial', 'Meta', 'Hyper', 'Ultra'];
                        const stageIcons = ['🌱', '🔄', '⚡', '🎯'];
                        
                        stageCard.innerHTML = `
                            <div class="result-header">
                                <div class="model-name">${stageIcons[index]} ${stageNames[index]} Stage</div>
                                <div class="stage-info">${stage.models?.join(', ') || 'Processing...'}</div>
                            </div>
                            <div class="result-content">${stage.result || 'Processing stage...'}</div>
                        `;
                        
                        resultsContainer.appendChild(stageCard);
                    });
                } else if (data.result) {
                    // Fallback for simple result format from old orchestrator
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    
                    // Check for API key errors
                    let responseText = data.result.response || data.result;
                    let isApiError = responseText && (responseText.includes('API key') || responseText.includes('invalid_request_error'));
                    
                    if (isApiError) {
                        document.getElementById('apiStatus').style.display = 'block';
                        resultCard.innerHTML = `
                            <div class="result-header">
                                <div class="model-name">⚠️ API Configuration</div>
                            </div>
                            <div class="api-status error">API keys are configured but there may be an issue. The system returned: ${responseText}</div>
                        `;
                    } else {
                        resultCard.innerHTML = `
                            <div class="result-header">
                                <div class="model-name">🎯 UltraAI Analysis Result</div>
                            </div>
                            <div class="result-content">${responseText}</div>
                        `;
                    }
                    resultsContainer.appendChild(resultCard);
                } else {
                    // Error case
                    resultsContainer.innerHTML = `<div class="error">Unexpected response format: ${JSON.stringify(data)}</div>`;
                }
            }

            displayResults(results) {
                // Legacy method - keep for backwards compatibility
                this.displayFeatherResults({stages: results.map(r => ({result: r.response, models: [r.model]}))});
            }

            async loadConfigurationStatus() {
                try {
                    const response = await fetch('/config/status');
                    const config = await response.json();
                    
                    const statusElement = document.getElementById('configStatus');
                    const contentElement = document.getElementById('configStatusContent');
                    const instructionsElement = document.getElementById('configInstructions');
                    
                    // Update status display
                    if (config.configured) {
                        statusElement.className = 'config-status production-mode';
                        contentElement.innerHTML = `
                            <strong>✅ PRODUCTION MODE</strong><br>
                            API Keys configured for: ${Object.entries(config.providers)
                                .filter(([name, provider]) => provider.configured)
                                .map(([name]) => name.toUpperCase())
                                .join(', ')}
                        `;
                        instructionsElement.style.display = 'none';
                    } else {
                        statusElement.className = 'config-status demo-mode';
                        contentElement.innerHTML = `
                            <strong>⚠️ DEMO MODE</strong><br>
                            ${config.error}<br>
                            The system will return placeholder responses until API keys are configured.
                        `;
                        instructionsElement.innerHTML = config.instructions.join('<br>');
                        instructionsElement.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Failed to load configuration status:', error);
                    const contentElement = document.getElementById('configStatusContent');
                    contentElement.innerHTML = '❌ Failed to load configuration status';
                }
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new OrchestratorApp();
        });
    </script>
</body>
</html>